{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "azureuser",
      "metadata": {
        "description": "Admin username for VMs"
      }
    },
    "adminPublicKey": {
      "type": "securestring",
      "metadata": {
        "description": "SSH public key for authentication"
      }
    },
    "vnetName": {
      "type": "string",
      "defaultValue": "backtest-vnet",
      "metadata": {
        "description": "Name of the existing VNet"
      }
    },
    "transformVmSize": {
      "type": "string",
      "defaultValue": "Standard_B2s",
      "metadata": {
        "description": "Size of the transform VM"
      }
    },
    "vmssInstanceCount": {
      "type": "int",
      "defaultValue": 2,
      "minValue": 1,
      "maxValue": 20,
      "metadata": {
        "description": "Number of VMSS instances"
      }
    },
    "vmssVmSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "Size of VMSS worker VMs"
      }
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage account name for worker to connect to"
      }
    }
  },
  "variables": {
    "transformVmName": "transform-vm",
    "transformNicName": "transform-vm-nic",
    "transformPipName": "transform-vm-pip",
    "vmssName": "backtest-workers",
    "vmssNsgName": "vmss-nsg",
    "storageBlobDataContributorRole": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "storageQueueDataContributorRole": "974c5e8b-45b9-4653-ba55-5f855dd0fb88"
  },
  "resources": [
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2023-05-01",
      "name": "[variables('transformPipName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard"
      },
      "properties": {
        "publicIPAllocationMethod": "Static"
      }
    },
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2023-05-01",
      "name": "[variables('vmssNsgName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "AllowSSH",
            "properties": {
              "priority": 1000,
              "protocol": "Tcp",
              "access": "Allow",
              "direction": "Inbound",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "22"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2023-05-01",
      "name": "[variables('transformNicName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('transformPipName'))]",
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('vmssNsgName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), 'transform-subnet')]"
              },
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('transformPipName'))]"
              }
            }
          }
        ],
        "networkSecurityGroup": {
          "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('vmssNsgName'))]"
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2023-07-01",
      "name": "[variables('transformVmName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', variables('transformNicName'))]"
      ],
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('transformVmSize')]"
        },
        "osProfile": {
          "computerName": "[variables('transformVmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "linuxConfiguration": {
            "disablePasswordAuthentication": true,
            "ssh": {
              "publicKeys": [
                {
                  "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
                  "keyData": "[parameters('adminPublicKey')]"
                }
              ]
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "Canonical",
            "offer": "0001-com-ubuntu-server-jammy",
            "sku": "22_04-lts-gen2",
            "version": "latest"
          },
          "osDisk": {
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "Standard_LRS"
            }
          }
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('transformNicName'))]"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachineScaleSets",
      "apiVersion": "2023-07-01",
      "name": "[variables('vmssName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('vmssNsgName'))]"
      ],
      "identity": {
        "type": "SystemAssigned"
      },
      "sku": {
        "name": "[parameters('vmssVmSize')]",
        "tier": "Standard",
        "capacity": "[parameters('vmssInstanceCount')]"
      },
      "properties": {
        "overprovision": false,
        "upgradePolicy": {
          "mode": "Manual"
        },
        "virtualMachineProfile": {
          "osProfile": {
            "computerNamePrefix": "worker",
            "adminUsername": "[parameters('adminUsername')]",
            "linuxConfiguration": {
              "disablePasswordAuthentication": true,
              "ssh": {
                "publicKeys": [
                  {
                    "path": "[concat('/home/', parameters('adminUsername'), '/.ssh/authorized_keys')]",
                    "keyData": "[parameters('adminPublicKey')]"
                  }
                ]
              }
            }
          },
          "storageProfile": {
            "imageReference": {
              "publisher": "Canonical",
              "offer": "0001-com-ubuntu-server-jammy",
              "sku": "22_04-lts-gen2",
              "version": "latest"
            },
            "osDisk": {
              "createOption": "FromImage",
              "managedDisk": {
                "storageAccountType": "Standard_LRS"
              }
            }
          },
          "networkProfile": {
            "networkInterfaceConfigurations": [
              {
                "name": "vmss-nic",
                "properties": {
                  "primary": true,
                  "ipConfigurations": [
                    {
                      "name": "ipconfig1",
                      "properties": {
                        "subnet": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), 'vmss-subnet')]"
                        }
                      }
                    }
                  ],
                  "networkSecurityGroup": {
                    "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('vmssNsgName'))]"
                  }
                }
              }
            ]
          },
          "extensionProfile": {
            "extensions": [
              {
                "name": "workerSetup",
                "properties": {
                  "publisher": "Microsoft.Azure.Extensions",
                  "type": "CustomScript",
                  "typeHandlerVersion": "2.1",
                  "autoUpgradeMinorVersion": true,
                  "settings": {
                    "script": "[base64(concat('#!/bin/bash\napt-get update\napt-get install -y python3 python3-pip\npip3 install azure-identity azure-storage-queue azure-storage-blob pandas numpy pyarrow\ncat > /home/azureuser/worker.py << ''EOF''\nimport os,json,time\nfrom azure.identity import DefaultAzureCredential\nfrom azure.storage.queue import QueueServiceClient\nfrom azure.storage.blob import BlobServiceClient\nimport pandas as pd\nimport numpy as np\nfrom io import BytesIO\nSTORAGE_ACCOUNT_NAME=\"', parameters('storageAccountName'), '\"\nQUEUE_NAME=\"backtest-jobs\"\nDATA_CONTAINER=\"raw-data\"\nRESULTS_CONTAINER=\"backtest-results\"\nTRADING_FEE=0.001\ndef get_credential():\n    return DefaultAzureCredential()\ndef get_queue_client():\n    credential=get_credential()\n    account_url=f\"https://{STORAGE_ACCOUNT_NAME}.queue.core.windows.net\"\n    queue_service=QueueServiceClient(account_url=account_url,credential=credential)\n    return queue_service.get_queue_client(QUEUE_NAME)\ndef get_blob_service():\n    credential=get_credential()\n    account_url=f\"https://{STORAGE_ACCOUNT_NAME}.blob.core.windows.net\"\n    return BlobServiceClient(account_url=account_url,credential=credential)\ndef load_price_data(blob_service,coin):\n    blob_client=blob_service.get_blob_client(DATA_CONTAINER,f\"{coin}.parquet\")\n    stream=BytesIO()\n    stream.write(blob_client.download_blob().readall())\n    stream.seek(0)\n    df=pd.read_parquet(stream)\n    return df[[\"timestamp\",\"close\"]]\ndef run_backtest(prices,fast_ma,slow_ma):\n    df=prices.copy()\n    df[\"fast\"]=df[\"close\"].rolling(window=fast_ma).mean()\n    df[\"slow\"]=df[\"close\"].rolling(window=slow_ma).mean()\n    df=df.dropna()\n    if len(df)==0:\n        return {\"total_return\":0.0,\"num_trades\":0,\"win_rate\":0.0}\n    df[\"signal\"]=0\n    df.loc[df[\"fast\"]>df[\"slow\"],\"signal\"]=1\n    df.loc[df[\"fast\"]<df[\"slow\"],\"signal\"]=-1\n    position=0\n    entry_price=0\n    trades=[]\n    for i,row in df.iterrows():\n        if row[\"signal\"]==1 and position==0:\n            position=1\n            entry_price=row[\"close\"]*(1+TRADING_FEE)\n        elif row[\"signal\"]==-1 and position==1:\n            exit_price=row[\"close\"]*(1-TRADING_FEE)\n            pnl=(exit_price-entry_price)/entry_price\n            trades.append(pnl)\n            position=0\n    if len(trades)==0:\n        return {\"total_return\":0.0,\"num_trades\":0,\"win_rate\":0.0}\n    total_return=np.prod([1+t for t in trades])-1\n    win_rate=sum(1 for t in trades if t>0)/len(trades)\n    return {\"total_return\":total_return,\"num_trades\":len(trades),\"win_rate\":win_rate}\ndef save_result(blob_service,result):\n    blob_client=blob_service.get_blob_client(RESULTS_CONTAINER,f\"{result[''coin'']}_{result[''fast_ma'']}_{result[''slow_ma'']}.json\")\n    blob_client.upload_blob(json.dumps(result),overwrite=True)\ndef process_job(blob_service,job):\n    coin=job[\"coin\"]\n    fast_ma=job[\"fast_ma\"]\n    slow_ma=job[\"slow_ma\"]\n    prices=load_price_data(blob_service,coin)\n    result=run_backtest(prices,fast_ma,slow_ma)\n    result[\"coin\"]=coin\n    result[\"fast_ma\"]=fast_ma\n    result[\"slow_ma\"]=slow_ma\n    return result\ndef worker_loop():\n    import socket\n    hostname=socket.gethostname()\n    print(f\"Worker starting on {hostname}...\")\n    queue_client=get_queue_client()\n    blob_service=get_blob_service()\n    jobs_processed=0\n    while True:\n        messages=queue_client.receive_messages(max_messages=1,visibility_timeout=300)\n        message=None\n        for msg in messages:\n            message=msg\n            break\n        if message is None:\n            print(f\"Queue empty. {hostname} processed {jobs_processed} jobs.\")\n            break\n        try:\n            job=json.loads(message.content)\n            result=process_job(blob_service,job)\n            save_result(blob_service,result)\n            queue_client.delete_message(message)\n            jobs_processed+=1\n            print(f\"[{hostname}] Job {jobs_processed}: {result[''coin'']} return={result[''total_return'']:.2%}\")\n        except Exception as e:\n            print(f\"Error: {e}\")\n            continue\n    print(f\"Worker {hostname} finished.\")\nif __name__==\"__main__\":\n    worker_loop()\nEOF\nchown azureuser:azureuser /home/azureuser/worker.py\ncd /home/azureuser\nnohup python3 worker.py > /var/log/worker.log 2>&1 &'))]"
                  }
                }
              }
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, variables('vmssName'), variables('storageBlobDataContributorRole'))]",
      "scope": "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmssName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageBlobDataContributorRole'))]",
        "principalId": "[reference(resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmssName')), '2023-07-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(resourceGroup().id, variables('vmssName'), variables('storageQueueDataContributorRole'))]",
      "scope": "[concat('Microsoft.Storage/storageAccounts/', parameters('storageAccountName'))]",
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmssName'))]"
      ],
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('storageQueueDataContributorRole'))]",
        "principalId": "[reference(resourceId('Microsoft.Compute/virtualMachineScaleSets', variables('vmssName')), '2023-07-01', 'Full').identity.principalId]",
        "principalType": "ServicePrincipal"
      }
    }
  ],
  "outputs": {
    "transformVmPublicIp": {
      "type": "string",
      "value": "[reference(variables('transformPipName')).ipAddress]"
    },
    "vmssName": {
      "type": "string",
      "value": "[variables('vmssName')]"
    }
  }
}
